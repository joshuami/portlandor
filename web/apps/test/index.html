<html>
<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>

  <style>
    #map { height: 100%; }

  </style>
</head>

<body>

  <div id="map"></div>

  <script>
    // var map = L.map('map').setView([51.505, -0.09], 13);
    // L.tileLayer('https://www.portlandmaps.com/arcgis/rest/services/Public/Basemap_Color_Complete/MapServer/tile/{z}/{y}/{x}', {
    //   attribution: 'PortlandMaps ESRI',
    //   maxZoom: 18
    // }).addTo(map);

    initBaseMap();
    loadReports();

    function initBaseMap() {
      // initializes the base leaflet map and positions zoom controls
      var layer = L.tileLayer('https://www.portlandmaps.com/arcgis/rest/services/Public/Basemap_Color_Complete/MapServer/tile/{z}/{y}/{x}', {
          attribution: "PortlandMaps ESRI"
      });
      var zoomcontrols = new L.control.zoom({ position: 'topright' });
      var map = new L.Map("map", {
          center: new L.LatLng(45.51, -122.65),
          tap: false,
          zoomControl: false,
          zoom: 12
      });
      map.addLayer(layer);
      map.addControl(zoomcontrols);
      return map;
    }

    function loadReports() {
      var reverseGeocodeUrl = `https://www.portlandmaps.com/arcgis/rest/services/Public/Geocoding_PDX/GeocodeServer/reverseGeocode?location=%7B%22x%22%3A${lng}%2C+%22y%22%3A${lat}%2C+%22spatialReference%22%3A%7B%22wkid%22+%3A+4326%7D%7D&distance=100&langCode=&locationType=&featureTypes=&outSR=4326&returnIntersection=false&f=json`;
      // arcgis_reversegeocode_url = `https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/reverseGeocode?f=json&locationType=street&location=${lng},${lat}`;
      $.ajax({
        url: reverseGeocodeUrl, success: function (response) {
          if (response.length < 1 || !response.address || !response.location) {
            // portlandmaps doesn't have data for this location.
            // set location type to "other" so 311 can triage but still set marker.
            // and clear address field; address is not required for "other."
            setMarkerAndZoom(lat, lng, true, false, DEFAULT_ZOOM_CLICK);
            if (locationType == "park") {
              setLocationType("other");
            }
            $('#location_address').val("");
            setUnverified();
            return false;
            // showStatusModal("There was a problem retrieving data for the selected location.");
          }
          processReverseLocationData(response, lat, lng);
        }
      });

    }

  </script>
</body>
</html>